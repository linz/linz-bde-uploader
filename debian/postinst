#!/bin/bash

set -e

SCRIPT=${0##*/}
SUCCESS=0
FAILURE=1

die()
{
    msg=$1
    err_no=$2
    echo "$SCRIPT: $msg" 1>&2
    exit ${err_no:-$FAILURE}
}

# Make sure the database is installed and running.

LDS_PACKAGE=linz-bde-uploader
LDS_SHARE_DIR=/usr/share/$LDS_PACKAGE
LDS_LOG_DIR=/var/log/$LDS_PACKAGE
LDS_USER=lds_bde
PG_USER=postgres
DB=bde_db
PG_SERVICE=postgresql
PG_INIT=/etc/init.d/$PG_SERVICE
USE_SERVICE=0

if [ -x /usr/sbin/service ]; then
    USE_SERVICE=1
fi

if [ ! -x $PG_INIT ]; then
    die "Can not find $PG_INIT init script"
fi

if [ $USE_SERVICE ]; then
  cmd="service $PG_SERVICE status"
else
  cmd="$PG_INIT status"
fi
$cmd
rc=$?
if [ $rc -ne $SUCCESS ]; then
    if [ $USE_SERVICE ]; then
        cmd="service $PG_SERVICE start"
    else
        cmd="$PG_INIT start"
    fi
    $cmd
    rc=$?
    if [ $rc -ne $SUCCESS ]; then
      die "There was a problem starting the $PG_SERVICE service"
    fi
fi

# create bde database if it does not exists
if ! su -l $PG_USER -c "psql --list | grep $DB"; then
    su -l $PG_USER -c "createdb -O $PG_USER -E UTF8 -T template0 -l C $DB"
    rc=$?
    
    if [ $rc -ne $SUCCESS ] ; then
        die "Could not create database" $rc
    fi
    
    su -l $PG_USER -c "createlang plperlu $DB"
    rc=$?
    if [ $rc -ne $SUCCESS ] ; then
        die "Could not install plperlu database language" $rc
    fi
    
    su -l $PG_USER -c "createlang plperl $DB"
    rc=$?
    if [ $rc -ne $SUCCESS ] ; then
        die "Could not install plperl database language" $rc
    fi
    
    su -l $PG_USER -c "psql -d $PG_USER -f /usr/share/postgresql/9.0/contrib/adminpack.sql"
    rc=$?
    if [ $rc -ne $SUCCESS ] ; then
        die "Could not install database admin pack" $rc
    fi
    
    su -l $PG_USER -c "psql -d $DB -f /usr/share/postgresql/9.0/contrib/postgis-1.5/postgis.sql"
    rc=$?
    if [ $rc -ne $SUCCESS ] ; then
        die "Could install postgis functions" $rc
    fi
    
    su -l $PG_USER -c "psql -d $DB -f /usr/share/postgresql/9.0/contrib/postgis-1.5/spatial_ref_sys.sql"
    rc=$?
    if [ $rc -ne $SUCCESS ] ; then
        die "Could install postgis SRS data" $rc
    fi
fi

SQL_FILES="
    $LDS_SHARE_DIR/sql/bde_roles.sql
    $LDS_SHARE_DIR/sql/bde_schema.sql
    $LDS_SHARE_DIR/sql/bde_schema_index_lds.sql
    $LDS_SHARE_DIR/sql/bde_functions.sql
    $LDS_SHARE_DIR/sql/table_version_tables.sql
    $LDS_SHARE_DIR/sql/table_version_functions.sql
    $LDS_SHARE_DIR/sql/bde_control_tables.sql
    $LDS_SHARE_DIR/sql/bde_control_functions.sql
    $LDS_SHARE_DIR/sql/lds_layer_tables.sql
    $LDS_SHARE_DIR/sql/patch_management.sql
    $LDS_SHARE_DIR/sql/patches.sql
    $LDS_SHARE_DIR/sql/lds_layer_functions.sql
"

for SQL_FILE in $SQL_FILES
do
    su -l $PG_USER -c "psql -d $DB -f $SQL_FILE"
    rc=$?
    if [ $rc -ne $SUCCESS ] ; then
        die "Could install SQL file: $SQL_FILE" $rc
    fi
done

# creating lds user group if it isn't already there
if ! getent group $LDS_USER >/dev/null; then
    addgroup --group $LDS_USER >/dev/null
fi

# creating lds user if he isn't already there
if ! getent passwd $LDS_USER >/dev/null; then
        adduser \
          --system \
          --ingroup $LDS_USER \
          --gecos "LDS BDE Maintainer" \
        $LDS_USER  >/dev/null
fi

if ! su -l $PG_USER -c "psql -t -c \"select 1 from pg_roles where rolname = '$LDS_USER' AND rolcanlogin = TRUE\"" | grep 1; then
    # Create $LDS_USER user without password
    su -l $PG_USER -c "psql -c 'CREATE ROLE $LDS_USER LOGIN NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE'"
    su -l $PG_USER -c "psql -c 'ALTER ROLE $LDS_USER SET search_path=bde, bde_control, lds, table_version, public'"
    su -l $PG_USER -c "psql -c 'GRANT bde_dba TO $LDS_USER'";
fi;


# now create log directory if it does not exist.
if [ ! -d $LDS_LOG_DIR ]; then
    mkdir -p $LDS_LOG_DIR
fi
chown -R $LDS_USER:adm $LDS_LOG_DIR;
chmod 0755 $LDS_LOG_DIR;

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
